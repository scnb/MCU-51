C51 COMPILER V9.01   DS1302                                                                01/25/2017 22:05:34 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE DS1302
OBJECT MODULE PLACED IN .\output\ds1302.obj
COMPILER INVOKED BY: F:\51\C51\BIN\C51.EXE source\ds1302.c BROWSE DEBUG OBJECTEXTEND PRINT(.\ds1302.lst) OBJECT(.\output
                    -\ds1302.obj)

line level    source

   1          
   2          /*ds1302Ïà¹Øº¯Êý*/
   3          #include "inc/ds1302.h"
   4          #include "reg52.h"
   5          #include "inc/lcd1602.h"
   6          
   7          /*¶Ôds1302µÄÒý½Å½øÐÐÉèÖÃ*/
   8          sbit RST = P3^7;
   9          sbit SCL = P3^5;
  10          sbit SDA = P3^6;
  11          
  12          #define write_addr 0x80;
  13          #define read_addr  0x81;
  14          
  15          /*¸´Î»ds1302    Ã¿´Î·¢ÆðÊý¾Ý´«ÊäÇ°£¬ÐèÒª¸´Î»1302*/
  16          void reset_1302()
  17          {
  18   1              RST = 0;
  19   1              SCL = 0;
  20   1              RST = 1;
  21   1      }
  22          
  23          /*Ð´Êý¾Ý*/
  24          void write_data_1302(unsigned char dat)
  25          {
  26   1              unsigned char i;
  27   1              SCL = 0;
  28   1              for(i = 0;i < 8;i++)
  29   1              {
  30   2                      SDA = dat&0x01;
  31   2                      SCL = 1;
  32   2                      dat >>= 1;
  33   2                      SCL = 0;//½«ÕâÒ»¾ä·Åµ½dat×óÒÆÏÂÃæ£¬¿ÉÒÔÆðµ½ÑÓÊ±µÄ×÷ÓÃ,ÑÓ³¤ÁËÒ»¸öÖ¸ÁîµÄÊ±¼ä
  34   2              }
  35   1      }
  36          
  37          /*¶ÁÊý¾Ý*/
  38          unsigned char read_data_1302()
  39          {
  40   1              unsigned char dat = 0;
  41   1              unsigned char i;
  42   1              for(i = 0;i < 8;i++)
  43   1              {
  44   2                      SCL = 0;
  45   2                      dat >>= 1;
  46   2                      if(SDA)
  47   2                      {
  48   3                              dat |= 0x80;
  49   3                      }
  50   2                      SCL = 1;
  51   2              }
  52   1              return dat;
  53   1      }
  54          
C51 COMPILER V9.01   DS1302                                                                01/25/2017 22:05:34 PAGE 2   

  55          /*½«Êý¾ÝÐ´Èëds1302*/
  56          void write_ds1302(unsigned char addr,unsigned char dat)
  57          {
  58   1              reset_1302();
  59   1              RST = 1;
  60   1              write_data_1302(addr);
  61   1              write_data_1302(dat);
  62   1              SDA = 0;   //¹Ø±ÕÊý¾ÝÏß£¬·ÀÖ¹Êý¾Ý²»Ð¡ÐÄ±»ÐÞ¸Ä
  63   1              RST = 0;  //·ÀÖ¹ds1302¸´Î»µ¼ÖÂÊý¾Ý¶ªÊ§£¿
  64   1      }
  65          
  66          /*´Óds1302ÖÐ¶ÁÈ¡Êý¾Ý*/
  67          unsigned char read_ds1302(unsigned char addr)
  68          {
  69   1              unsigned char temp = 0;
  70   1              reset_1302();
  71   1              RST = 1;
  72   1              write_data_1302(addr);
  73   1              temp = read_data_1302();
  74   1              SDA = 0;
  75   1              RST = 0;
  76   1              return temp;
  77   1      }
  78          
  79          
  80          /*Ð´±£»¤º¯Êý*/
  81          void write_protect()
  82          {
  83   1              reset_1302();
  84   1              RST = 1;
  85   1              write_ds1302(0x8e,0x80);
  86   1              SDA = 0;
  87   1              RST = 0;
  88   1      }
  89                                                                                                                                                   
  90          /*Çå³ýÐ´±£»¤*/
  91          void clear_write_protect()
  92          {
  93   1              reset_1302();
  94   1              RST = 1;
  95   1              write_ds1302(0x8e,0);
  96   1              SDA = 0;
  97   1              RST = 0;
  98   1      }
  99          
 100          
 101          
 102          /*Éè¶¨ds1302Ê±¼ä*/
 103          void set_time_ds1302(unsigned char *timedata)
 104          {
 105   1              unsigned char i;
 106   1              unsigned char tmp;
 107   1              for(i = 0;i < 7;i++)
 108   1              {
 109   2                      tmp = timedata[i]/10;                      //ÒÔÏÂÈý¾äÓï¾ä½«Ê®½øÖÆµÄÊý×ª»»³ÉÁËBCDÂëÐÎÊ½Ëù¶ÔÓ¦µÄÊ®½øÖÆÊý
 110   2                      timedata[i] = timedata[i]%10;
 111   2                      timedata[i] = timedata[i] + tmp*16;             
 112   2              }
 113   1              clear_write_protect();
 114   1              tmp = write_addr;
 115   1              for(i = 0;i < 7;i++)  //Ïòds1302ÖÐ´«ÈëÊý×éÖÐµÄÊý¾Ý£¬¼´ÄêÔÂÈÕÊ±·ÖÃë
 116   1              {
C51 COMPILER V9.01   DS1302                                                                01/25/2017 22:05:34 PAGE 3   

 117   2                      write_ds1302(tmp,timedata[i]);
 118   2                      tmp += 2;//Á½¸ö×Ö½Ú´æÒ»´Î  //ÒòÎª0x80¶ÔÓ¦µÄÊÇÃëÔÚ¼Ä´æÆ÷ÖÐµÄ´æ´¢µØÖ·£¬0x82ÊÇ·Ö¶ÔÓ¦µÄ´æ´¢µØÖ·¡¤¡¤¡¤¡¤ÒÀ´ÎÀ
             -àÍÆ
 119   2              }
 120   1              write_protect();
 121   1      }
 122          
 123          /*¶ÁÈ¡ds1302ÖÐµÄÊ±¼ä*/
 124          void read_time_ds1302(unsigned char *timedata)
 125          {
 126   1              unsigned char i;
 127   1              unsigned char tmp;
 128   1              tmp = read_addr;
 129   1              for(i = 0;i < 7;i++)
 130   1              {
 131   2                      timedata[i] = (read_ds1302(tmp)/16*10+read_ds1302(tmp)%16);
 132   2                      tmp += 2;
 133   2              }
 134   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    285    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
